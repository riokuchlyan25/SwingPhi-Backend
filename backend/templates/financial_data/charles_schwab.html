<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Charles Schwab API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; }
        .container { max-width: 800px; margin: auto; }
        .form-section { margin-bottom: 2em; padding: 1em; border: 1px solid #ddd; border-radius: 5px; }
        .response, .error, .info { margin-top: 1em; padding: 1em; border-radius: 5px; }
        .response { background: #f0f8ff; }
        .error { background: #ffe0e0; color: #a00; }
        .info { background: #e8f5e8; color: #2d5a2d; }
        label, input, textarea { display: block; width: 100%; margin-top: 0.5em; }
        textarea { height: 100px; }
        button { margin-top: 1em; padding: 0.5em 1em; }
        .data-display { max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 1em; margin-top: 1em; }
        .step { background: #f9f9f9; padding: 1em; margin-bottom: 1em; border-radius: 5px; }
        .step h4 { margin-top: 0; color: #333; }
        .auth-url { background: #fff3cd; padding: 1em; border-radius: 5px; margin: 1em 0; }
        .auth-url a { word-break: break-all; }
    </style>
</head>
<body>
<div class="container">
    <h1>Charles Schwab API Testing</h1>
    
    <div class="info">
        <h3>OAuth 2.0 Flow for Charles Schwab</h3>
        <p>This interface helps you test the Charles Schwab OAuth authentication process. Follow the steps below:</p>
    </div>

    <div class="step">
        <h4>Step 1: Get Authorization URL</h4>
        <p>Click the button below to get the Charles Schwab authorization URL.</p>
        <button type="button" onclick="getAuthUrl()">Get Authorization URL</button>
    </div>

    <div class="step">
        <h4>Step 2: Handle OAuth Callback</h4>
        <p>After completing authorization, you'll be redirected back with an authorization code. The callback will be handled automatically at <code>/financial_data/charles_schwab_callback/</code></p>
    </div>

    <div class="form-section">
        <h3>Step 3: Refresh Access Token</h3>
        <p>Use this form to refresh your access token using a refresh token:</p>
        <form id="refreshForm">
            {% csrf_token %}
            <label for="refresh_token">Refresh Token:</label>
            <textarea id="refresh_token" name="refresh_token" placeholder="Enter your refresh token here..." required></textarea>
            <button type="button" onclick="refreshToken()">Refresh Access Token</button>
        </form>
    </div>

    <div class="form-section">
        <h3>Token Storage</h3>
        <p>Store your tokens here for easy access during testing:</p>
        <label for="access_token_display">Access Token:</label>
        <textarea id="access_token_display" placeholder="Your access token will appear here..." readonly></textarea>
        
        <label for="refresh_token_display">Refresh Token:</label>
        <textarea id="refresh_token_display" placeholder="Your refresh token will appear here..." readonly></textarea>
        
        <div style="margin-top: 1em;">
            <button type="button" onclick="clearTokens()">Clear Tokens</button>
            <button type="button" onclick="copyAccessToken()">Copy Access Token</button>
        </div>
    </div>

    <div id="response-container"></div>
</div>

<script>
async function getAuthUrl() {
    const responseContainer = document.getElementById('response-container');
    
    try {
        responseContainer.innerHTML = '<div>Getting authorization URL...</div>';
        
        const response = await fetch('/financial_data/charles_schwab/', {
            method: 'GET'
        });
        
        const data = await response.json();
        
        if (data.error) {
            responseContainer.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        } else {
            responseContainer.innerHTML = `
                <div class="response">
                    <strong>Authorization URL Generated:</strong>
                    <div class="auth-url">
                        <p><strong>Click the link below to authorize with Charles Schwab:</strong></p>
                        <a href="${data.auth_url}" target="_blank">${data.auth_url}</a>
                    </div>
                    <p><strong>Message:</strong> ${data.message}</p>
                    <p><strong>Instructions:</strong></p>
                    <ol>
                        <li>Click the authorization URL above</li>
                        <li>Log in to your Charles Schwab account</li>
                        <li>Grant permission to your application</li>
                        <li>You'll be redirected back to the callback URL automatically</li>
                        <li>The tokens will be displayed in the response</li>
                    </ol>
                </div>
            `;
        }
    } catch (error) {
        responseContainer.innerHTML = `<div class="error">Network Error: ${error.message}</div>`;
    }
}

async function refreshToken() {
    const refreshToken = document.getElementById('refresh_token').value;
    const responseContainer = document.getElementById('response-container');
    
    if (!refreshToken) {
        responseContainer.innerHTML = '<div class="error">Please enter a refresh token</div>';
        return;
    }
    
    try {
        responseContainer.innerHTML = '<div>Refreshing access token...</div>';
        
        const formData = new FormData();
        formData.append('refresh_token', refreshToken);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        const response = await fetch('/financial_data/charles_schwab_refresh/', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
            responseContainer.innerHTML = `<div class="error">Error: ${data.error}</div>`;
        } else {
            // Store tokens in display areas
            document.getElementById('access_token_display').value = data.access_token;
            
            responseContainer.innerHTML = `
                <div class="response">
                    <strong>Token Refreshed Successfully!</strong>
                    <div class="data-display">
                        <p><strong>Success:</strong> ${data.success}</p>
                        <p><strong>Message:</strong> ${data.message}</p>
                        <p><strong>Access Token:</strong> ${data.access_token.substring(0, 50)}...</p>
                        <p><strong>Token Type:</strong> ${data.token_type}</p>
                        <p><strong>Expires In:</strong> ${data.expires_in} seconds</p>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        responseContainer.innerHTML = `<div class="error">Network Error: ${error.message}</div>`;
    }
}

function clearTokens() {
    document.getElementById('access_token_display').value = '';
    document.getElementById('refresh_token_display').value = '';
    document.getElementById('refresh_token').value = '';
    document.getElementById('response-container').innerHTML = '<div class="info">Tokens cleared</div>';
}

function copyAccessToken() {
    const accessToken = document.getElementById('access_token_display').value;
    if (accessToken) {
        navigator.clipboard.writeText(accessToken).then(function() {
            document.getElementById('response-container').innerHTML = '<div class="info">Access token copied to clipboard!</div>';
        });
    } else {
        document.getElementById('response-container').innerHTML = '<div class="error">No access token to copy</div>';
    }
}

// Check if we're on the callback page and there's a code in URL
window.onload = function() {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    if (code) {
        document.getElementById('response-container').innerHTML = `
            <div class="info">
                <strong>Authorization Code Received!</strong>
                <p>Code: ${code}</p>
                <p>The token exchange should happen automatically via the callback endpoint.</p>
            </div>
        `;
    }
};
</script>
</body>
</html> 